#!/bin/bash
#
# cs_show_hana_info
#
# (c) 2018 SUSE Linux GmbH, Germany. Author: L.Pinne.
# GNU General Public License v2. No warranty.
#
# Version: 2018-11-23
#

EXE="$0"
#CFG="/etc/ClusterTools2/cs_show_hana_info"
#test -s $CFG && source $CFG

MYHOST=$(hostname)

test -z "${TEMP}" &&\
	TEMP="/dev/shm/cltl.$RANDOM"

function show_help() {
	echo "usage	$(basename $0) [ --help | --version ]"
	echo "	$(basename $0) [ --info | --logs ] <sid> <inst_nr>"
	echo
	echo " --help		show help."
	echo " --version	show version."
	echo " --info <sid> <inst_nr>	show info for given instance."
	echo " --logs <sid> <inst_nr>	show logs for given instance."
	echo
	exit
}

function show_info() {

	su - ${SID}adm || exit 1

	echo "hostname: ${MYHOST}" >${TEMP} || exit 2
	echo "sid: $SID" >>${TEMP}
	echo "inst_nr: $INR" >>${TEMP}

	RC_ALL=0

	sapcontrol -nr $INR -function GetProcessList >>${TEMP}
	RC=$? ; RC_ALL=$[ $RC_ALL + $RC ]
	echo "sapcontrol -nr $INR -function GetProcessList: RC: "$RC

	hdbnsutil -sr_state >>${TEMP}
	RC=$? ; RC_ALL=$[ $RC_ALL + $RC ]
	echo "hdbnsutil -sr_state: RC: "$RC >>${TEMP}

	HDBSettings.sh landscapeHostConfiguration.py --sapcontrol=1 >>${TEMP}
	RC=$? ; RC_ALL=$[ $RC_ALL + $RC ]
	echo "landscapeHostConfiguration.py: RC: "$RC >>${TEMP}

	HDBSettings.sh systemReplicationStatus.py >>${TEMP}
	RC=$? ; RC_ALL=$[ $RC_ALL + $RC ]
	echo "systemReplicationStatus.py: RC: "$RC >>${TEMP}

	HDB info >>${TEMP}
	RC=$? ; RC_ALL=$[ $RC_ALL + $RC ]
	echo "HDB info : RC: "$RC >>${TEMP}

	HDBSettings.sh systemOverview.py >>${TEMP}
	RC=$? ; RC_ALL=$[ $RC_ALL + $RC ]
	echo "HDBSettings.sh systemOverview.py: RC: "$RC >>${TEMP}

	cat ${TEMP} && rm ${TEMP}
}

function show_logs() {

	su - ${SID}adm || exit 1

	RC_ALL=0

	# TODO awk ... /hana/shared/${SID}/HDB${INR}/${MYHOST}/trace/*.trc
	# 5th? column = "e"
	# ? column = "DISK FULL"
	echo "not implemented yet"
}


# main()
case $1 in
	-v|--version)
		echo -n "$(basename $EXE) "
		head -11 $EXE | grep "^# Version: "
		exit
	;;
	-i|--info)
		test $# -eq 3 || show_help
		SID=$(echo $1 | tr "[:upper:]" "[:lower:]")
		INR=$2
		show_info
		exit $RC_ALL
	;;
	-l|--logs)
		test $# -eq 3 || show_help
		SID=$(echo $1 | tr "[:upper:]" "[:lower:]")
		INR=$2
		show_logs
		exit $RC_ALL
	;;
	*)
		show_help
		exit
	;;
esac
#
