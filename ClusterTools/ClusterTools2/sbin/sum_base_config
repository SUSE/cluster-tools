#!/bin/bash
#
# sum_base_config
#
# (c) 2011 SUSE Linux GmbH, Germany. Author: L.Pinne.
# GNU Public License. No warranty.
#
# Version: 0.1 2011-04-13
#

EXE="$0"

CFG="/etc/ClusterTools2/sum_base_config"
test -s $CFG && source $CFG

TMP="/tmp/cltl.$RANDOM"

test -z "${CONF_FILES}" &&\
	 CONF_FILES="
/etc/SuSE-release
/etc/zypp/zypp.conf
/etc/products.d/*.prod
/proc/cmdline
/proc/sys/kernel/tainted
/etc/inittab
/etc/hosts
/etc/ntp.conf
/etc/passwd
/etc/group
/etc/drbd.conf
/etc/drbd.d/*
/etc/lvm/lvm.conf
/etc/multipath.conf
/etc/multipath.bind
/etc/mdadm.conf
/clusterconf/*/mdadm.*.conf
/etc/iscsi/iscsid.conf
/etc/iscsi/initiatorname.iscsi
/etc/sysconfig/kernel
/etc/sysconfig/sbd
/etc/sysconfig/oracle
/etc/sysconfig/sapconf
/etc/sysconfig/ulimit
/etc/sysconfig/uuidd
/etc/oratab
/etc/security/limits.conf
/etc/pam.d/login
/etc/sysctl.conf
/etc/modprobe.conf.local
/etc/logrotate.d/corosync
/etc/corosync/corosync.conf
/etc/corosync/logd.cf
/etc/corosync/authkey
/etc/xen/xend-config.sxp
"
# TODO: /boot/initrd, boot/vmlinuz
# TODO: exact grep patterns
test -z "${CONF_CALLS}" &&\
	 CONF_CALLS="
'/usr/bin/grep "model.name" /proc/cpuinfo'
'/usr/bin/grep "MemTotal:" /proc/meminfo'
'/bin/uname -a'
'/bin/lsmod'
'/bin/rpm -qa'
'/bin/rpm -Va'
'/bin/multipath -ll'
'/bin/cat /proc/mounts'
'/sbin/chkconfig -A'
'/sbin/route -n'
'/usr/sbin/iptables -L'
"
# TODO: network hardware, disk hardware


function help() {
	echo "usage:	$(basename $0)"
	echo "	$(basename $0) [OPTION]"
	echo
	echo " --help		show help."
	echo " --version	show version."
	echo " --files		checksum files only."
	echo " --calls		checksum calls only."
	echo
	test $UID -gt 0 && echo "please call as root."
}


function sum_files() {
	nf=1
	f=$CFG
	S="NA"
	test -r $f && S=$(md5sum $f | awk '{print $1}')
	echo "$f $S"
	# TODO: better loop
	for f in ${CONF_FILES}; do
		(( nf++ ))
		S="NA"
		test -r $f && S=$(md5sum $f | awk '{print $1}')
        	echo "$f = $S"
	done
	echo "INFO: $nf files" >>/dev/stderr
}


function sum_calls() {
	# TODO: replace errors by "$REPLY = NA" as above
	nc=0
	echo ${CONF_CALLS} | tr "'" "\n" | tr -s "\n" |\
	while read; do
		echo -n "'${REPLY}' = "
		${REPLY} | sort | md5sum - | awk '{print $1}'
		(( nc++ ))
		echo $nc >$TMP
	done | grep -v "'.*d41d8cd98f00b204e9800998ecf8427e"
	nc=$(cat $TMP)
	echo "INF0: $nc calls" >>/dev/stderr
	rm $TMP
}


# main()

case $1 in
	-v|--version)
		echo -n "$(basename $EXE) "
        	head -11 $EXE | grep "^# Version: "
		exit
	;;
	-h|--help)
		help
		exit
	;;
	-f|--files)
		test $UID -gt 0 && echo "please call as root." && exit
		sum_files
		exit
	;;
	-c|--calls)
		test $UID -gt 0 && echo "please call as root." && exit
		sum_calls
		exit
	;;
	*)
		test $UID -gt 0 && echo "please call as root." && exit
		sum_files
		sum_calls
		exit		
	;;
esac
#
