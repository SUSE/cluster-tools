#!/bin/bash
#
# add_mod_to_initrd
#
# (c) 2011 SUSE Linux GmbH, Germany.
# GNU Public License. No warranty.
# Author: A.Rehg, L.Pinne
# 
# Version: 0.01 2011-06-08 12:50
#

EXE="add_mod_to_initrd"
MOD=${1:-"softdog"}
FIL="/etc/sysconfig/kernel"
BAK=${FIL}.bak

echo "INFO: start $EXE $FUNCNAME"
test -s $FIL || exit 2
grep -v "#.*INITRD_MODULES" $FIL | grep "INITRD_MODULES=.*$MOD" >/dev/null
RC=$?

if [ $RC -gt 0 ]; then
	cp -a $FIL $BAK || exit $?
	awk -F'"' '     $1=="INITRD_MODULES=" {print $1"\""$2" '"$MOD"'\" "}
        	        $1!="INITRD_MODULES=" {print}' $BAK >$FIL
	mkinitrd
else
        echo "WARN: found \"${MOD}\" already in ${FIL}"
fi 
	modprobe $MOD

echo "INFO: normal_end $EXE $FUNCNAME"
#
