#!/bin/bash
#
# cs_detect_sleha
#
# (c) 2016 SUSE Linux GmbH, Germany. Author: L.Pinne.
# GNU General Public License v2. No warranty.
# http://www.gnu.org/licenses/gpl.html
#
# Version: 2016-08-04 12:00 SLES11
#

EXE="$0"
ERR="/dev/null"

CFG="/etc/ClusterTools2/cs_detect_sleha"
test -s $CFG && source $CFG
DELCIBCFG="/etc/ClusterTools2/cs_delcib"
test -s $DELCIBCFG && source $DELCIBCFG

test -z "${SLEHA_BASE_FIL}" &&\
	SLEHA_BASE_FIL="
/etc/corosync/corosync.conf
/var/lib/pacemaker/cib/cib.xml
"
test -z "${SLEHA_MISC_FIL}" &&\
	SLEHA_MISC_FIL="
/etc/products.d/sle-hae.prod
/etc/corosync/authkey
/var/lib/corosync/ringid_*
/var/lib/pacemaker/pengine/*
/etc/csync2/csync2.cfg
/etc/drbd.conf
/var/cache/zypp/raw/*/suse/setup/descr/ha_sles*.pat.gz
"
test -z "${SLEHA_KERN_FIL}" &&\
	SLEHA_KERN_FIL="
/etc/drbd.conf
/etc/ocfs2/cluster.conf
/etc/sysconfig/o2cb
/etc/rear/local.conf
"
test -z "${SLEHA_BASE_RPM}" &&\
	SLEHA_BASE_RPM="
openais
corosync
crmsh
pacemaker
resource-agents
cluster-glue
libglue2
libcorosync4
libpacemaker3
libopenais3
"
test -z "${SLEHA_MISC_RPM}" &&\
	SLEHA_MISC_RPM="
sle-hae-release
release-notes-hae
ocfs2-tools
csync2
pacemaker-mgmt
pacemaker-mgmt-client
hawk
drbd
yast2-cluster
yast2-drbd
yast2-iplb
ldirectord
lvm2-clvm
cmirrord
conntrack-tools
pssh
python-pssh
python-dateutil
sleha-bootstrap
ctdb
"
test -z "${SLEHA_KERN_RPM}" &&\
	SLEHA_KERN_RPM="
ocfs2-tools-o2cb
ocfs2-kmp-default
ocfs2-kmp-xen
drbd-utils
drbd-kmp-default
drbd-kmp-xen
rear
rear116
"
# find . -name "*.rpm" | while read; do rpm -qip $REPLY |\
# awk '$1=="Name" {print $3}'; done | sort
test -z "${SLEHA_REPO_RPM}" &&\
        SLEHA_REPO_RPM="
cluster-glue
cluster-network-kmp-default
cluster-network-kmp-trace
cluster-network-kmp-xen
cmirrord
conntrack-tools
corosync
crmsh
csync2
ctdb
drbd
drbd-bash-completion
drbd-heartbeat
drbd-kmp-default
drbd-kmp-trace
drbd-kmp-xen
drbd-pacemaker
drbd-udev
drbd-utils
drbd-xen
fence-agents
gfs2-kmp-default
gfs2-kmp-trace
gfs2-kmp-xen
graphviz-python
hawk
hawk-templates
ipvsadm
ldirectord
libcorosync4
libcorosync-devel
libdlm
libdlm3
libdlm-devel
libglue2
libglue-devel
libgnutls-extra26
libnetfilter_conntrack3
libnetfilter_conntrack-devel
libnfnetlink-devel
libopenais3
libopenais-devel
libpacemaker3
libpacemaker-devel
libqb0
libqb-devel
librsync
lighttpd
lvm2-clvm
nagios-plugins-metadata
ocfs2console
ocfs2-kmp-default
ocfs2-kmp-trace
ocfs2-kmp-xen
ocfs2-tools
ocfs2-tools-devel
ocfs2-tools-o2cb
openais
pacemaker
pacemaker-cli
pacemaker-mgmt
pacemaker-mgmt-client
pacemaker-mgmt-devel
pacemaker-remote
pssh
python-dateutil
python-pexpect
python-pssh
python-suds
rear
rear116
rear-SUSE
release-notes-hae
resource-agents
rubygem-bundler
rubygems
sbd
scsires
sleha-bootstrap
sle-hae-release
sle-hae-release-cd
sle-ha-guide_en-pdf
sleha-guide_ja
sleha-guide_ja-pdf
sleha-guide_zh_CN
sleha-guide_zh_CN-pdf
sleha-guide_zh_TW
sleha-guide_zh_TW-pdf
sle-ha-manuals_en
sle-ha-nfs-quick_en-pdf
sqlite2
yast2-cluster
yast2-drbd
yast2-iplb
yast2-multipath
yast2-rear
"
# from cs_delcib
test -z "${FIL}" &&\
        FIL="
/var/lib/corosync/*
/var/lib/heartbeat/cores/*/*
/var/lib/heartbeat/crm/*
/var/lib/pengine/*
/var/lib/pacemaker/cib/*
/var/lib/pacemaker/pengine/*
"
test -z "${BAK}" &&\
        BAK="/var/adm/backup/cib.xml-$(date +%Y%m%d-%H%M%S)"
#

CFGVAR="
SLEHA_BASE_FIL
SLEHA_MISC_FIL
SLEHA_KERN_FIL
SLEHA_BASE_RPM
SLEHA_MISC_RPM
SLEHA_KERN_RPM
SLEHA_REPO_RPM
"

# TODO show RPM list from pattern file

function help(){
	echo "usage:	$(basename $0) [OPTION]"
	echo
	echo " --help		show help"
	echo " --version	show version"
	echo " --writecfg	show some internal variables"
	echo
	echo " --detect	shown number of traces"
	echo " --installed	show installed base RPMs"
	echo " --available	show available base RPMs"
	echo " --standalone	show standalone services"
	echo " --files	show common files"
	echo " --pedantic	show even minimal traces of SLE-HA"
	echo " --removeall	remove RPMs, files, and repos of SLE-HA"
	echo " --uninstall	uninstall RPMs of SLE-HA"
	echo
}


function writecfg(){
	# TODO --writecfg <variable_name> show single variable
	#echo "INFO: ### $FUNCNAME $1 start ###" >/dev/stderr
	echo -e "# $CFG \n# For SLES11.\n#"
	for c in $CFGVAR; do
		echo "${c}=\""
		echo ${!c} | tr " " "\n"
		echo "\""
		echo "#"
	done
	#echo "INFO: ### $FUNCNAME $1 end ###" >/dev/stderr
}


function remove_files(){
	echo "INFO: ### $FUNCNAME $1 start ###"
	for f in $SLEHA_BASE_FIL $SLEHA_MISC_FIL $SLEHA_KERN_FIL; do
		rm -rf $f
	done
	echo "INFO: ### $FUNCNAME $1 end ###"
}


function remove_rpms(){
	echo "INFO: ### $FUNCNAME $1 start ###"
	case $1 in
		base)
		for f in $SLEHA_BASE_RPM; do
			timeout 5 zypper rm --no-force-resolution --no-clean-deps --quiet --yes $f 2>$ERR
		done
		;;
		misc)
		for f in $SLEHA_MISC_RPM; do
			timeout 5 zypper rm --no-force-resolution --no-clean-deps --quiet --yes $f 2>$ERR
		done
		;;
		kern)
		for f in $SLEHA_KERN_RPM; do
			timeout 5 zypper rm --no-force-resolution --no-clean-deps --quiet --yes $f 2>$ERR
		done
		;;
		repo)
		for f in $SLEHA_REPO_RPM; do
			timeout 5 zypper rm --no-force-resolution --no-clean-deps --quiet --yes $f 2>$ERR
		done
		;;
	esac
	echo "INFO: ### $FUNCNAME $1 end ###"
}


function remove_repos(){
	echo "INFO: ### $FUNCNAME $1 start ###"
	# TODO timeout 5 zypper rs (removeservice)
	# TODO timeout 5 zypper rr (removerepo)
	echo "INFO: ### $FUNCNAME $1 end ###"
}


function remove_cib(){
	echo "INFO: ### $FUNCNAME $1 start ###"
	#test -x /usr/sbin/cs_delcib && /usr/sbin/cs_delcib --offline
	for f in $FIL $BAK; do
		rm -rf $f
	done
	echo "INFO: ### $FUNCNAME $1 end ###"
}


function detect_files(){
	# TODO read variable name from call, avoid case
	echo "INFO: ### $FUNCNAME $1 start ###"
	case $1 in
		base)
		for f in $SLEHA_BASE_FIL; do
			ls -l $f 2>$ERR
		done
		;;
		misc)
		for f in $SLEHA_MISC_FIL; do
			ls -l $f 2>$ERR
		done
		;;
		kern)
		for f in $SLEHA_KERN_FIL; do
			ls -l $f 2>$ERR
		done
		;;
	esac
	echo "INFO: ### $FUNCNAME $1 end ###"
}


function detect_rpms(){
	# TODO read variable name from call, avoid case
	echo "INFO: ### $FUNCNAME $1 start ###"
	timeout 5 zypper ref 2>$ERR
	case $1 in
		base)
		for r in $SLEHA_BASE_RPM; do
			timeout 5 zypper se -s $r 2>$ERR ||\
			rpm -qa 2>$ERR | grep $r
		done
		;;
		misc)
		for r in $SLEHA_MISC_RPM; do
			timeout 5 zypper se -s $r 2>$ERR ||\
			rpm -qa 2>$ERR | grep $r
		done
		;;
		kern)
		for r in $SLEHA_KERN_RPM; do
			timeout 5 zypper se -s $r 2>$ERR ||\
			rpm -qa 2>$ERR | grep $r
		done
		;;
		repo)
		for r in $SLEHA_REPO_RPM; do
			timeout 5 zypper se -s $r 2>$ERR ||\
			rpm -qa 2>$ERR | grep $r
		done
		;;
	esac
	echo "INFO: ### $FUNCNAME $1 end ###"
}


function detect_repos(){
	echo "INFO: ### $FUNCNAME $1 start ###"
	# TODO detect repos
#	case $1 in
	#timeout 5 zypper ... --with-repos --sort-by-priority --details --uri
#	esac
	echo "INFO: ### $FUNCNAME $1 start ###"
}


# main()
case $1 in
	-v|--version)
		echo -n "$(basename $EXE) "
		head -11 $EXE | grep "^# Version: "
		exit
	;;
	-h|--help)
		help
		exit
	;;
	-w|--writecfg)
		writecfg
		exit
	;;
	-a|--available)
		detect_rpms base | grep -v "in.*\.\.\.$"
		exit
	;;
	-i|--installed)
		echo "INFO: ### detect_rpms base start ###"
		echo "S | Name             | Type       | Version      | Arch   | Repository "
		echo "-----------------------------------------------------------------------"
		detect_rpms base | grep -e "^i" -e "INFO:.*end"
		exit
	;;
	-f|--files)
		detect_files base
		detect_files misc
		detect_files kern 
		exit
	;;
	-s|--standalone)
		detect_files kern
		echo "INFO: ### detect_rpms kern start ###"
		echo "S | Name             | Type       | Version      | Arch   | Repository "
		echo "-----------------------------------------------------------------------"
		detect_rpms kern | grep -v "^INFO:.*start.###" | grep -v "in.*\.\.\.$" | grep -v "^S.\|.Name" |\
	 		grep -v "^Repository" | grep -v "^All.repositories" | grep -v "^No.packages.found" |\
			grep -v -- "^--+" | tr -s "\n"
		exit
		# TODO better grep, maybe positive filter function
	;;
	-p|--pedantic|--paranoid|--penetrant)
		detect_files base
		detect_files misc
		detect_files kern
		detect_rpms repo | grep -v "in.*\.\.\.$"
		exit
	;;
	-u|--uninstall)
		YESNO=no
		read -p "Uninstall RPMs of SLE-HA? [yes/no]: " YESNO
		[[ $YESNO == "yes" ]] || exit
		remove_rpms repo
		exit
	;;
	-r|--removeall)
		YESNO=no
		read -p "Remove RPMs, files, and repos of SLE-HA? [yes/no]: " YESNO
		[[ $YESNO == "yes" ]] || exit
		echo remove_files
		echo remove_rpms
		echo remove_cib
		# TODO remove_repos
		exit
	;;
	-d|--detect|*)
		#set -x
		RC=0
		RC=$(
		( detect_files base
                  detect_files misc
                  detect_files kern
                  detect_rpms repo | grep -v "in.*\.\.\.$" )|\
		grep -v "^INFO:.*###" | grep -v "^S.\|.Name" |\
		grep -v -- "^--+" | grep -v "^Repository" |\
		grep -v "^All.repositories" | grep -v "^No.packages.found" |\
		grep -v -- "-devel" | grep -v "sdksp.*-" |\
		grep -v "srcpackage" | tr -s "\n" 2>$ERR | wc -l )
		echo "${EXE}: Found $RC hints on SLE-HA" >/dev/stderr
		exit $RC
		# TODO add function's real rc ($?) to RC as well
		# TODO better excluding for RPMs from SDK (-devel)
		# TODO better grep, maybe positive filter function
	;;
esac
#
